<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceNote</title>

    <link rel="icon" href="./icon-192x192.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@latest"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-microphone text-4xl text-indigo-600 mr-3"></i>
                <h1 class="text-4xl font-bold text-gray-800">VoiceNote</h1>
            </div>
            <p class="text-indigo-600 font-medium">High-quality Speech Transcriber!</p>
        </div>

        <!-- Main Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Language and File Upload -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-language text-indigo-600 mr-2"></i> Convert
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="language">Language</label>
                            <select id="language" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="en-US">English (US)</option>
                                <option value="hi-IN">Hindi</option>
                                <option value="es-ES">Spanish</option>
                                <option value="fr-FR">French</option>
                                <option value="de-DE">German</option>
                                <option value="ja-JP">Japanese</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2" for="mediaFile">Media File</label>
                            <div class="relative">
                                <input type="file" id="mediaFile" accept="video/mp4,audio/wav,audio/mp3,audio/ogg" class="hidden" onchange="updateFileName()">
                                <button onclick="document.getElementById('mediaFile').click()" class="w-full px-4 py-2 border-2 border-dashed border-indigo-300 rounded-lg">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                                    <span id="fileName">Choose Media File</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversion Button -->
                <div>
                    <button onclick="convertSpeechToText()" id="convertButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg mb-4">
                        <i class="fas fa-sync-alt mr-2"></i> Convert to Text
                    </button>

                    <!-- Progress -->
                    <div id="progressContainer" class="hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-gray-600 mt-2 text-center"></p>
                    </div>
                </div>
            </div>

            <!-- Result -->
            <div class="mt-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Transcribed Text</label>
                <textarea id="result" rows="6" readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg"></textarea>
                <button onclick="copyToClipboard()" class="mt-2 px-4 py-2 bg-gray-600 text-white rounded-lg">
                    Copy to Clipboard
                </button>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <button onclick="toggleConfig()" class="w-full px-6 py-4 text-left font-semibold text-gray-800 hover:bg-gray-50 focus:outline-none">
                <div class="flex items-center">
                    <i class="fas fa-cog text-indigo-600 mr-2"></i> App Settings
                </div>
            </button>
            <div id="configPanel" class="hidden px-6 pb-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="apiKey">Key</label>
                        <input type="password" id="apiKey" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="region">Region</label>
                        <input type="text" id="region" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="centralindia">
                    </div>
                    <button onclick="saveApiKey()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        function updateFileName() {
            const input = document.getElementById('mediaFile');
            const fileName = document.getElementById('fileName');
            fileName.textContent = input.files.length ? input.files[0].name : 'Choose Media File';
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            const region = document.getElementById('region').value;
            localStorage.setItem('azureApiKey', apiKey);
            localStorage.setItem('azureRegion', region);
            alert('Settings saved successfully!');
        }

        async function extractAudioFromMP4(file) {
            if (!ffmpeg.isLoaded()) await ffmpeg.load();

            const inputFileName = 'input.mp4';
            const outputFileName = 'output.wav';

            ffmpeg.FS('writeFile', inputFileName, await fetchFile(file));
            await ffmpeg.run('-i', inputFileName, '-vn', '-acodec', 'pcm_s16le', '-ar', '44100', '-ac', '1', outputFileName);

            const data = ffmpeg.FS('readFile', outputFileName);
            return new Blob([data.buffer], { type: 'audio/wav' });
        }

        async function convertSpeechToText() {
            const apiKey = localStorage.getItem('azureApiKey');
            const region = localStorage.getItem('azureRegion');
            const mediaFile = document.getElementById('mediaFile').files[0];
            const language = document.getElementById('language').value;
            const resultArea = document.getElementById('result');

            if (!apiKey || !region || !mediaFile) {
                alert('Please ensure all settings are configured and a file is uploaded.');
                return;
            }

            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');

            progressContainer.classList.remove('hidden');
            progressText.textContent = 'Processing...';

            let audioBlob = mediaFile;
            if (mediaFile.type === 'video/mp4') {
                audioBlob = await extractAudioFromMP4(mediaFile);
            }

            const audioFile = new File([audioBlob], 'audio.wav', { type: 'audio/wav' });

            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(apiKey, region);
            speechConfig.speechRecognitionLanguage = language;
            const audioConfig = SpeechSDK.AudioConfig.fromWavFileInput(audioFile);
            const recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

            recognizer.recognized = (s, e) => {
                if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    resultArea.value += e.result.text + ' ';
                }
            };

            recognizer.startContinuousRecognitionAsync(
                () => {
                    progressText.textContent = 'Transcription complete!';
                },
                (err) => {
                    console.error(err);
                    progressText.textContent = 'Error occurred.';
                }
            );
        }

        function toggleConfig() {
            const configPanel = document.getElementById('configPanel');
            configPanel.classList.toggle('hidden');
        }

        function copyToClipboard() {
            const resultArea = document.getElementById('result');
            resultArea.select();
            document.execCommand('copy');
            alert('Text copied to clipboard!');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem('azureApiKey');
            const savedRegion = localStorage.getItem('azureRegion');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
            if (savedRegion) {
                document.getElementById('region').value = savedRegion;
            }
        });
    </script>
</body>
</html>
